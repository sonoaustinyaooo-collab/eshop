<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>結帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .checkout-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .order-summary-section {
            position: sticky;
            top: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-4">

    <!-- 返回購物車按鈕 -->
    <a th:href="@{/cart}" class="btn btn-secondary mb-3">
        <i class="bi bi-arrow-left"></i> 返回購物車
    </a>

    <h1><i class="bi bi-credit-card"></i> 結帳</h1>

    <!-- 錯誤訊息 -->
    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>錯誤！</strong> <span th:text="${param.error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- 左側：收件人資訊表單 -->
        <div class="col-md-7">
            
            <!-- 收件人資訊 -->
            <div class="checkout-section">
                <h4><i class="bi bi-person-fill"></i> 收件人資訊</h4>
                <hr>
                
                <form th:action="@{/orders/create}" method="post" id="checkoutForm">
                    
                    <!-- 收件人姓名 -->
                    <div class="mb-3">
                        <label for="recipientName" class="form-label">
                            <i class="bi bi-person"></i> 收件人姓名 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="recipientName" 
                               name="recipientName"
                               th:value="${customer != null ? customer.custName : ''}"
                               required
                               placeholder="請輸入收件人姓名">
                    </div>
                    
                    <!-- 收件人電話 -->
                    <div class="mb-3">
                        <label for="recipientPhone" class="form-label">
                            <i class="bi bi-telephone"></i> 收件人電話 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="tel" 
                               class="form-control" 
                               id="recipientPhone" 
                               name="recipientPhone"
                               th:value="${customer != null ? customer.custPhone : ''}"
                               required
                               placeholder="請輸入手機號碼，例如：0912345678">
                    </div>
                    
                    <!-- 收件地址 -->
                    <div class="mb-3">
                        <label for="shippingAddress" class="form-label">
                            <i class="bi bi-geo-alt"></i> 收件地址 
                            <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="shippingAddress" 
                                  name="shippingAddress"
                                  rows="3"
                                  required
                                  placeholder="請輸入完整地址，包含縣市、鄉鎮、街道和門牌號碼"
                                  th:text="${customer != null ? customer.custAddress : ''}"></textarea>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            請填寫完整地址以確保順利配送
                        </small>
                    </div>
                    
                    <!-- 訂單備註 -->
                    <div class="mb-3">
                        <label for="orderNote" class="form-label">
                            <i class="bi bi-chat-left-text"></i> 訂單備註（選填）
                        </label>
                        <textarea class="form-control" 
                                  id="orderNote" 
                                  name="orderNote"
                                  rows="3"
                                  placeholder="如有特殊需求或備註事項，請在此填寫"></textarea>
                    </div>
                    
                    <hr>
                    
                    <!-- 確認條款 -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="agreeTerms" 
                               required>
                        <label class="form-check-label" for="agreeTerms">
                            我已閱讀並同意<a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">服務條款</a>與<a href="#">隱私權政策</a>
                            <span class="text-danger">*</span>
                        </label>
                    </div>
                    
                    <!-- 按鈕群組 -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> 確認訂單
                        </button>
                        <a th:href="@{/cart}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 返回購物車
                        </a>
                    </div>
                    
                </form>
            </div>
            
        </div>

        <!-- 右側：訂單摘要 -->
        <div class="col-md-5">
            <div class="order-summary-section">
                <div class="checkout-section">
                    <h4><i class="bi bi-cart-check"></i> 訂單摘要</h4>
                    <hr>
                    
                    <!-- 商品列表 -->
                    <div class="mb-3">
                        <div th:each="item : ${cart.cartItems}" class="d-flex justify-content-between mb-2">
                            <div class="flex-grow-1">
                                <div>
                                    <strong th:text="${item.product.prodName}">產品名稱</strong>
                                </div>
                                <small class="text-muted">
                                    <span th:text="'NT$ ' + ${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                                    × 
                                    <span th:text="${item.quantity}"></span>
                                </small>
                            </div>
                            <div>
                                <strong th:text="'NT$ ' + ${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')}">$0</strong>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- 總計資訊 -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>商品總數：</span>
                        <span th:text="${cart.totalItems} + ' 件'">0 件</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>商品小計：</span>
                        <span th:text="'NT$ ' + ${#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 0, 'POINT')}">$0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>運費：</span>
                        <span class="text-success">免運費</span>
                    </div>
                    
                    <hr>
                    
                    <!-- 總金額 -->
                    <div class="d-flex justify-content-between mb-3">
                        <h5>總金額：</h5>
                        <h5 class="text-danger" 
                            th:text="'NT$ ' + ${#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 0, 'POINT')}">$0</h5>
                    </div>
                    
                    <!-- 提示訊息 -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            點擊「確認訂單」後，系統將建立您的訂單，並清空購物車。
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 服務條款 Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">服務條款</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>一、服務說明</h6>
                <p>本網站提供線上購物服務，當您完成訂單後，我們將盡快為您處理並配送商品。</p>
                
                <h6>二、訂單處理</h6>
                <p>訂單成立後，我們將在 1-2 個工作天內處理您的訂單，並安排出貨。</p>
                
                <h6>三、配送說明</h6>
                <p>我們提供全台配送服務，標準配送時間為 3-5 個工作天。</p>
                
                <h6>四、退換貨政策</h6>
                <p>商品收到後 7 天內，如有瑕疵或不符需求，可申請退換貨。</p>
                
                <h6>五、個人資料保護</h6>
                <p>我們重視您的隱私權，您的個人資料僅用於訂單處理及配送，不會外洩給第三方。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 表單驗證
document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    const phone = document.getElementById('recipientPhone').value;
    const phonePattern = /^09\d{8}$/;
    
    if (!phonePattern.test(phone)) {
        e.preventDefault();
        alert('請輸入正確的手機號碼格式（例如：0912345678）');
        document.getElementById('recipientPhone').focus();
        return false;
    }
    
    // 確認提交
    if (!confirm('確定要送出訂單嗎？')) {
        e.preventDefault();
        return false;
    }
});
</script>
</body>
</html>