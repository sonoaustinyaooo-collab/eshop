<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>購物車</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    .cart-summary {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
</style>
</head>
<body>
<div class="container mt-4">

    <!-- 返回首頁按鈕 -->
    <a th:href="@{/}" class="btn btn-secondary mb-3">← 返回首頁</a>

    <h1>🛒 我的購物車</h1>

    <!-- 錯誤訊息顯示 -->
    <div th:if="${error}" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle"></i> 錯誤：<span th:text="${error}"></span>
    </div>
    
    <div th:if="${param.error}" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle"></i> 錯誤：<span th:text="${param.error}"></span>
    </div>

    <!-- 未登入狀態 -->
    <div th:if="${notLoggedIn}" class="alert alert-warning mt-4">
        <div class="text-center py-5">
            <i class="bi bi-person-x" style="font-size: 4rem; color: #856404;"></i>
            <h3 class="mt-3">您尚未登入</h3>
            <p class="lead">請先登入以查看您的購物車</p>
            <div class="mt-4">
                <!-- 登入頁面連結 -->
                <a href="login" class="btn btn-primary btn-lg me-2">
                    <i class="bi bi-box-arrow-in-right"></i> 登入
                </a>
                <a th:href="@{/}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-house"></i> 返回首頁
                </a>
            </div>
        </div>
    </div>

    <!-- 已登入但購物車是空的 -->
    <div th:if="${!notLoggedIn && (cart == null || cart.cartItems == null || cart.cartItems.isEmpty())}" 
         class="alert alert-info mt-4">
        <div class="text-center py-5">
            <i class="bi bi-cart-x" style="font-size: 4rem; color: #0c5460;"></i>
            <h3 class="mt-3">購物車是空的</h3>
            <p class="lead">快去選購商品吧！</p>
            <a th:href="@{/products}" class="btn btn-primary btn-lg mt-3">
                <i class="bi bi-bag"></i> 前往商品列表
            </a>
        </div>
    </div>

    <!-- 購物車有商品時顯示 -->
    <div th:if="${!notLoggedIn && cart != null && cart.cartItems != null && !cart.cartItems.isEmpty()}">
        
        <div class="row">
            <!-- 左側：購物車項目列表 -->
            <div class="col-md-8">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>產品</th>
                            <th>單價</th>
                            <th>數量</th>
                            <th>小計</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 使用 th:each 遍歷購物車項目 -->
                        <tr th:each="item : ${cart.cartItems}">
                            <!-- 產品資訊 -->
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="ms-3">
                                        <h6 class="mb-0" th:text="${item.product.prodName}">產品名稱</h6>
                                        <small class="text-muted" th:text="${item.product.prodType}">產品類型</small>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- 單價 -->
                            <td>
                                <span th:text="'NT$ ' + ${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')}">$0</span>
                            </td>
                            
                            <!-- 數量（可編輯） -->
                            <td>
                                <form th:action="@{/cart/update/{id}(id=${item.cartItemId})}" method="post" class="d-inline">
                                    <div class="input-group" style="width: 120px;">
                                        <input type="number" 
                                               name="quantity" 
                                               th:value="${item.quantity}" 
                                               min="1" 
                                               class="form-control form-control-sm">
                                        <button type="submit" class="btn btn-sm btn-outline-primary">更新</button>
                                    </div>
                                </form>
                            </td>
                            
                            <!-- 小計 -->
                            <td>
                                <strong th:text="'NT$ ' + ${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')}">$0</strong>
                            </td>
                            
                            <!-- 移除按鈕 -->
                            <td>
                                <a th:href="@{/cart/remove/{id}(id=${item.cartItemId})}" 
                                   class="btn btn-sm btn-danger"
                                   onclick="return confirm('確定要移除此商品嗎？')">
                                    <i class="bi bi-trash"></i> 移除
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- 清空購物車按鈕 -->
                <div class="mt-3">
                    <a th:href="@{/cart/clear}" 
                       class="btn btn-outline-danger"
                       onclick="return confirm('確定要清空購物車嗎？')">
                        <i class="bi bi-trash"></i> 清空購物車
                    </a>
                    <a th:href="@{/products}" class="btn btn-outline-secondary">
                        <i class="bi bi-bag"></i> 繼續購物
                    </a>
                </div>
            </div>

            <!-- 右側：購物車摘要 -->
            <div class="col-md-4">
                <div class="cart-summary">
                    <h4>訂單摘要</h4>
                    <hr>
                    
                    <!-- 總商品數量 -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>商品總數：</span>
                        <span th:text="${cart.totalItems} + ' 件'">0 件</span>
                    </div>
                    
                    <!-- 總金額 -->
                    <div class="d-flex justify-content-between mb-3">
                        <span>總金額：</span>
                        <strong class="text-primary" 
                                th:text="'NT$ ' + ${#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 0, 'POINT')}">$0</strong>
                    </div>
                    
                    <hr>
                    
                    <!-- ⭐ 修改：結帳按鈕改為連結 -->
                    <a th:href="@{/orders/checkout}" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-credit-card"></i> 前往結帳
                    </a>
                    
                    <!-- 購物車資訊 -->
                    <small class="text-muted d-block mt-3">
                        <i class="bi bi-info-circle"></i> 
                        更新時間：<span th:text="${#dates.format(cart.updatedDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </small>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>