<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>我的訂單</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
/* 訂單卡片樣式 */
.order-card {
	border: 1px solid #dee2e6; /* 邊框 */
	border-radius: 8px; /* 圓角 */
	padding: 15px;
	margin-bottom: 15px;
	transition: box-shadow 0.3s; /* 陰影過渡動畫 */
}

/* 滑鼠移到卡片上時的效果 */
.order-card:hover {
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* 加深陰影 */
}

/* 訂單狀態徽章 */
.status-badge {
	padding: 0.3rem 0.8rem;
	border-radius: 15px;
	font-size: 0.9rem;
}
</style>
</head>
<body>
	<div class="container mt-4">

		<!-- 返回首頁按鈕 -->
		<a th:href="@{/}" class="btn btn-secondary mb-3"> <i
			class="bi bi-house"></i> 返回首頁
		</a>

		<h1 class="mb-4">
			<i class="bi bi-bag-check"></i> 我的訂單
		</h1>

		<!-- 錯誤訊息 -->
		<div th:if="${param.error}" class="alert alert-danger" role="alert">
			<!-- ${param.error} 從 URL 參數取得 error 的值 -->
			<!-- 例如：/orders?error=取消失敗 -->
			<i class="bi bi-exclamation-triangle"></i> 錯誤：<span
				th:text="${param.error}"></span>
		</div>

		<!-- 未登入狀態 -->
		<div th:if="${notLoggedIn}"
			class="alert alert-warning text-center py-5">
			<i class="bi bi-person-x" style="font-size: 3rem;"></i>
			<h3 class="mt-3">您尚未登入</h3>
			<p class="lead">請先登入以查看您的訂單</p>
			<a href="#" class="btn btn-primary btn-lg"> <i
				class="bi bi-box-arrow-in-right"></i> 登入
			</a>
		</div>

		<!-- 已登入但沒有訂單 -->
		<!-- !notLoggedIn 表示已登入 -->
		<!-- orders.isEmpty() 表示訂單列表是空的 -->
		<div th:if="${!notLoggedIn && (orders == null || orders.isEmpty())}"
			class="alert alert-info text-center py-5">
			<i class="bi bi-inbox" style="font-size: 3rem;"></i>
			<h3 class="mt-3">目前沒有訂單</h3>
			<p class="lead">快去挑選商品吧！</p>
			<a th:href="@{/}" class="btn btn-primary btn-lg"> <i
				class="bi bi-bag"></i> 前往購物
			</a>
		</div>

		<!-- 訂單列表 -->
		<!-- !notLoggedIn && orders != null && !orders.isEmpty() -->
		<!-- 表示：已登入 且 訂單列表不為 null 且 訂單列表不是空的 -->
		<div th:if="${!notLoggedIn && orders != null && !orders.isEmpty()}">

			<!-- 訂單數量統計 -->
			<div class="alert alert-light">
				<!-- orders.size() 取得訂單列表的數量 -->
				共有 <strong th:text="${orders.size()}">0</strong> 筆訂單
			</div>

			<!-- 遍歷每個訂單 -->
			<!-- th:each="order : ${orders}" -->
			<!-- 將 orders 集合的每個元素命名為 order，逐一處理 -->
			<div th:each="order : ${orders}" class="order-card">

				<!-- 訂單標題列 -->
				<div class="d-flex justify-content-between align-items-center mb-2">
					<div>
						<!-- 訂單編號（可點擊查看詳情） -->
						<!-- th:href 生成連結 URL -->
						<!-- @{/orders/{id}(id=${order.orderId})} -->
						<!-- {id} 會被 (id=${order.orderId}) 替換 -->
						<!-- 例如：/orders/5 -->
						<h5>
							<a th:href="@{/orders/{id}(id=${order.orderId})}"
								class="text-decoration-none"> <!-- text-decoration-none 移除下劃線 -->
								訂單編號：<span th:text="${order.orderNumber}">ORD123456</span>
							</a>
						</h5>

						<!-- 訂單時間 -->
						<small class="text-muted"> <i class="bi bi-clock"></i> <span
							th:text="${#dates.format(order.createdDate, 'yyyy-MM-dd HH:mm')}">2025-01-01
								12:00</span>
						</small>
					</div>

					<!-- 訂單狀態徽章 -->
					<div>
						<!-- 根據訂單狀態顯示不同顏色 -->
						<span class="badge status-badge"
							th:classappend="${order.orderStatus.name() == 'PENDING_PAYMENT'} ? 'bg-warning text-dark' :
                                         ${order.orderStatus.name() == 'PAID'} ? 'bg-info' :
                                         ${order.orderStatus.name() == 'PROCESSING'} ? 'bg-primary' :
                                         ${order.orderStatus.name() == 'SHIPPED'} ? 'bg-secondary' :
                                         ${order.orderStatus.name() == 'DELIVERED'} ? 'bg-success' :
                                         'bg-danger'"
							th:text="${order.orderStatus.displayName}"> 待付款 </span>
					</div>
				</div>

				<!-- 訂單商品預覽 -->
				<div class="mb-2">
					<strong>訂單商品：</strong>
					<!-- 顯示前 3 個商品 -->
					<!-- th:each 配合 iterStat（迭代狀態變數） -->
					<!-- iterStat.index 是當前索引（從 0 開始） -->
					<span th:each="item, iterStat : ${order.orderItems}"
						th:if="${iterStat.index < 3}"> <!-- 顯示產品名稱 --> <span
						th:text="${item.productName}">產品</span> <!-- 如果不是最後一個，加上逗號 --> <span
						th:if="${iterStat.index < 2 && iterStat.index < order.orderItems.size() - 1}">,
					</span>
					</span>
					<!-- 如果商品超過3 個，顯示「...」 -->
					<span th:if="${order.orderItems.size() > 3}">...</span>
				</div>
				<!-- 訂單總金額 -->
				<div class="mb-3">
					<strong>訂單總額：</strong> <span class="text-success fs-5"
						th:text="'$' + ${order.totalAmount}">$0</span>
				</div>

				<!-- 訂單操作按鈕 -->
				<div class="d-flex gap-2">
					<!-- gap-2 設定元素之間的間距 -->

					<!-- 查看詳情按鈕 -->
					<a th:href="@{/orders/{id}(id=${order.orderId})}"
						class="btn btn-primary btn-sm"> <i class="bi bi-eye"></i> 查看詳情
					</a>

					<!-- 只有特定狀態才顯示取消按鈕 -->
					<!-- 待付款或已付款才能取消 -->
					<form
						th:if="${order.orderStatus.name() == 'PENDING_PAYMENT' or order.orderStatus.name() == 'PAID'}"
						th:action="@{/orders/{id}/cancel(id=${order.orderId})}"
						method="post" style="display: inline;">
						<button type="submit" class="btn btn-danger btn-sm"
							onclick="return confirm('確定要取消訂單：' + '[[${order.orderNumber}]]' + ' 嗎？')">
							<!-- [[${...}]] 是 Thymeleaf 的內聯語法，可以在 JavaScript 中使用 -->
							<i class="bi bi-x-circle"></i> 取消訂單
						</button>
					</form>
				</div>

			</div>

		</div>
	</div>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>