<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.prodNum != null} ? '編輯產品' : '新增產品'">產品表單</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        /* ===== 頁面整體樣式 ===== */
        body {
            background-color: #f8f9fa;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        /* ===== 圖片預覽樣式 ===== */
        .image-preview {
            max-width: 100%;
            height: 300px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            transition: border-color 0.3s;
        }
        
        .image-preview:hover {
            border-color: #999;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 280px;
            object-fit: contain;
        }
        
        .image-preview .placeholder {
            color: #6c757d;
            text-align: center;
        }
        
        /* ===== 表單標籤樣式 ===== */
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        
        .form-label .text-danger {
            color: #dc3545 !important;
        }
        
        /* ===== 必填欄位提示 ===== */
        .required-note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }
        
        /* ===== Textarea 樣式 ===== */
        textarea.form-control {
            resize: vertical;
            min-height: 150px;
        }
        
        /* ===== 字數統計樣式 ===== */
        .char-count {
            text-align: right;
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2">
                
                <!-- ===== 頁面標題 ===== -->
                <div class="form-container">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>
                            <i class="bi bi-box-seam"></i>
                            <span th:text="${product.prodNum != null} ? '編輯產品' : '新增產品'">產品表單</span>
                        </h2>
                        <a th:href="@{/products}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 返回列表
                        </a>
                    </div>
                    
                    <!-- ===== 必填欄位提示 ===== -->
                    <div class="required-note">
                        <i class="bi bi-info-circle"></i>
                        <strong>注意：</strong> 標有 <span class="text-danger">*</span> 的欄位為必填項目
                    </div>
                    
                    <!-- ========== 產品表單 ========== -->
                    <form th:action="${product.prodNum != null} ? @{/products/edit/{id}(id=${product.prodNum})} : @{/products/add}" 
                          method="post" 
                          th:object="${product}">
                        
                        <!-- ===== 產品名稱 ===== -->
                        <div class="mb-4">
                            <label for="prodName" class="form-label">
                                <i class="bi bi-tag-fill"></i> 產品名稱 <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="prodName" 
                                   th:field="*{prodName}"
                                   placeholder="請輸入產品名稱（例如：iPhone 15 Pro）"
                                   required
                                   autofocus>
                            <div class="form-text">
                                <i class="bi bi-lightbulb"></i> 提示：使用清晰、簡潔的產品名稱
                            </div>
                        </div>
                        
                        <!-- ===== 產品類型和產品線（並排） ===== -->
                        <div class="row mb-4">
                            <!-- 產品類型 -->
                            <div class="col-md-6">
                                <label for="prodType" class="form-label">
                                    <i class="bi bi-grid-fill"></i> 產品類型 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" 
                                        id="prodType" 
                                        th:field="*{prodType}"
                                        required>
                                    <option value="">請選擇類型</option>
                                    <option value="電子產品">電子產品</option>
                                    <option value="服飾">服飾</option>
                                    <option value="食品">食品</option>
                                    <option value="家居">家居</option>
                                    <option value="運動">運動</option>
                                    <option value="書籍">書籍</option>
                                    <option value="美妝">美妝</option>
                                    <option value="玩具">玩具</option>
                                </select>
                            </div>
                            
                            <!-- 產品線 -->
                            <div class="col-md-6">
                                <label for="prodLine" class="form-label">
                                    <i class="bi bi-diagram-3-fill"></i> 產品線
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="prodLine" 
                                       th:field="*{prodLine}"
                                       placeholder="例如：Apple、Nike、Sony">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> 選填：品牌或產品系列名稱
                                </div>
                            </div>
                        </div>
                        
                        <!-- ===== 產品價格 ===== -->
                        <div class="mb-4">
                            <label for="prodPrice" class="form-label">
                                <i class="bi bi-currency-dollar"></i> 產品價格 <span class="text-danger">*</span>
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">NT$</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="prodPrice" 
                                       th:field="*{prodPrice}"
                                       placeholder="0"
                                       step="1"
                                       min="0"
                                       required>
                                <span class="input-group-text">.00</span>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-calculator"></i> 請輸入整數價格（例如：35900）
                            </div>
                        </div>
                        
                        <!-- ===== 產品圖片 ===== -->
                        <div class="mb-4">
                            <label for="prodImage" class="form-label">
                                <i class="bi bi-image-fill"></i> 產品圖片
                            </label>
                            
                            <!-- 圖片檔名輸入框 -->
                            <input type="text" 
                                   class="form-control form-control-lg mb-2" 
                                   id="prodImage" 
                                   th:field="*{prodImage}"
                                   placeholder="請輸入圖片檔名（例如：product1.jpg）"
                                   oninput="updateImagePreview()">
                            
                            <!-- 圖片使用說明 -->
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle-fill"></i>
                                <strong>使用說明：</strong>
                                <ol class="mb-0 mt-2">
                                    <li>先將圖片放到資料夾：<code>src/main/webapp/resources/images/products/</code></li>
                                    <li>然後在上方輸入完整檔名（包含副檔名）</li>
                                    <li>支援格式：jpg, jpeg, png, gif, webp</li>
                                    <li>建議圖片尺寸：800x800 像素</li>
                                </ol>
                            </div>
                            
                            <!-- 圖片預覽區 -->
                            <div class="image-preview" id="imagePreview">
                                <!-- 如果編輯模式且已有圖片，顯示圖片 -->
                                <img th:if="${product.prodNum != null and product.hasImage()}" 
                                     th:src="@{/resources/images/products/{img}(img=${product.prodImage})}" 
                                     th:alt="${product.prodName}"
                                     id="previewImg">
                                
                                <!-- 如果新增模式或沒有圖片，顯示佔位文字 -->
                                <div th:if="${product.prodNum == null or !product.hasImage()}" 
                                     class="placeholder" 
                                     id="previewPlaceholder">
                                    <i class="bi bi-image" style="font-size: 4rem;"></i>
                                    <p class="mt-3 mb-2"><strong>圖片預覽區</strong></p>
                                    <small>輸入檔名後會自動顯示預覽</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ===== 產品描述 ===== -->
                        <div class="mb-4">
                            <label for="prodDescription" class="form-label">
                                <i class="bi bi-card-text"></i> 產品描述
                            </label>
                            
                            <!-- 多行文字輸入框 -->
                            <textarea class="form-control" 
                                      id="prodDescription" 
                                      th:field="*{prodDescription}"
                                      rows="8"
                                      placeholder="請輸入產品的詳細描述...&#10;&#10;建議包含以下內容：&#10;• 產品特色&#10;• 技術規格&#10;• 使用方法&#10;• 注意事項&#10;• 保固資訊"></textarea>
                            
                            <!-- 字數統計 -->
                            <div class="char-count mt-2">
                                已輸入 <strong><span id="charCount">0</span></strong> 字元
                            </div>
                            
                            <div class="form-text">
                                <i class="bi bi-journal-text"></i> 這段描述會顯示在商品詳細頁面，建議詳細說明產品的特色和規格
                            </div>
                        </div>
                        
                        <!-- ===== 表單按鈕 ===== -->
                        <hr class="my-4">
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a th:href="@{/products}" class="btn btn-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save"></i> 
                                <span th:text="${product.prodNum != null} ? '更新產品' : '新增產品'">儲存</span>
                            </button>
                        </div>
                        
                    </form>
                    <!-- ========== 產品表單結束 ========== -->
                    
                </div>
                
            </div>
        </div>
    </div>

    <!-- ===== JavaScript ===== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        /**
         * 更新圖片預覽
         * 
         * 功能說明：
         * 1. 當使用者在「產品圖片」欄位輸入檔名時
         * 2. 自動載入並顯示圖片預覽
         * 3. 如果圖片不存在，顯示錯誤訊息
         * 
         * 使用時機：
         * - 新增產品時輸入圖片檔名
         * - 編輯產品時修改圖片檔名
         */
        function updateImagePreview() {
            // 取得輸入的檔名
            const filename = document.getElementById('prodImage').value.trim();
            const previewContainer = document.getElementById('imagePreview');
            
            // 如果有輸入檔名
            if (filename) {
                // 建立圖片 URL（相對於網站根目錄）
                const imageUrl = '/resources/images/products/' + filename;
                
                // 更新預覽區內容
                previewContainer.innerHTML = `
                    <img src="${imageUrl}" 
                         alt="產品圖片預覽" 
                         onerror="showImageError()"
                         style="max-width: 100%; max-height: 280px; object-fit: contain;">
                `;
            } else {
                // 如果沒有輸入檔名，顯示佔位內容
                previewContainer.innerHTML = `
                    <div class="placeholder">
                        <i class="bi bi-image" style="font-size: 4rem;"></i>
                        <p class="mt-3 mb-2"><strong>圖片預覽區</strong></p>
                        <small>輸入檔名後會自動顯示預覽</small>
                    </div>
                `;
            }
        }
        
        /**
         * 顯示圖片載入錯誤訊息
         * 
         * 當圖片路徑錯誤或檔案不存在時呼叫
         */
        function showImageError() {
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = `
                <div class="placeholder text-danger">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 4rem;"></i>
                    <p class="mt-3 mb-2"><strong>找不到圖片</strong></p>
                    <small>請確認：<br>
                    1. 檔名是否正確（區分大小寫）<br>
                    2. 圖片是否已放到指定資料夾<br>
                    3. 檔案格式是否正確（jpg, png, gif, webp）</small>
                </div>
            `;
        }
        
        /**
         * 字數統計功能
         * 
         * 功能說明：
         * 即時顯示「產品描述」欄位的字元數
         * 幫助使用者掌握描述的長度
         */
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('prodDescription');
            const charCount = document.getElementById('charCount');
            
            if (textarea && charCount) {
                // 初始化字數（編輯模式時可能已有內容）
                charCount.textContent = textarea.value.length;
                
                // 監聽輸入事件，即時更新字數
                textarea.addEventListener('input', function() {
                    const count = textarea.value.length;
                    charCount.textContent = count;
                    
                    // 如果字數超過 1000，顯示警告顏色
                    if (count > 1000) {
                        charCount.style.color = '#dc3545';
                    } else {
                        charCount.style.color = '#6c757d';
                    }
                });
            }
        });
        
        /**
         * 表單驗證提示
         * 
         * 當使用者提交表單時，如果有必填欄位未填寫
         * 自動聚焦到第一個錯誤欄位
         */
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    // 檢查表單是否有效
                    if (!form.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // 找到第一個無效的欄位並聚焦
                        const firstInvalid = form.querySelector(':invalid');
                        if (firstInvalid) {
                            firstInvalid.focus();
                        }
                    }
                    
                    // 加入 Bootstrap 的驗證樣式
                    form.classList.add('was-validated');
                });
            }
        });
    </script>
</body>
</html>